<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Station Parameter Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>
  <h2>Select Stations (Searchable, Multi-Select)</h2>
  <select id="stationDropdown" multiple></select>
  <div id="plot" style="width: 100%; height: 600px; margin-top: 20px;"></div>

  <script>
    const csvURL = "https://raw.githubusercontent.com/DKevinM/AB_datapull/main/data/last6h.csv";
    let allData = [];

    Papa.parse(csvURL, {
      download: true,
      header: true,
      complete: function(results) {
        // Clean and filter valid data
        allData = results.data.filter(row => row.ParameterName && row.Value !== "");

        // Unique stations
        const stations = [...new Set(allData.map(row => row.StationName))].sort();

        // Setup Choices.js
        const dropdown = document.getElementById("stationDropdown");
        stations.forEach(station => {
          const option = document.createElement("option");
          option.value = station;
          option.textContent = station;
          dropdown.appendChild(option);
        });

        const choices = new Choices(dropdown, {
          removeItemButton: true,
          placeholder: true,
          placeholderValue: 'Select stations...',
          searchPlaceholderValue: 'Search stations...'
        });

        // Initial plot with the first station
        plotStations([stations[0]]);
        choices.setChoiceByValue([stations[0]]); // Pre-select

        // Handle selection change
        dropdown.addEventListener("change", () => {
          const selected = Array.from(dropdown.selectedOptions).map(opt => opt.value);
          plotStations(selected);
        });
      }
    });

    function plotStations(stationList) {
      const traces = [];

      stationList.forEach(station => {
        const stationData = allData.filter(row => row.StationName === station);
        const parameters = [...new Set(stationData.map(r => r.ParameterName))];

        parameters.forEach(param => {
          const paramData = stationData.filter(r => r.ParameterName === param);
          traces.push({
            x: paramData.map(r => r.ReadingDate),
            y: paramData.map(r => parseFloat(r.Value)),
            mode: 'lines+markers',
            name: `${param} (${station})`
          });
        });
      });

      Plotly.newPlot("plot", traces, {
        title: `Parameter Trends`,
        xaxis: { title: "Time" },
        yaxis: { title: "Value" },
        margin: { t: 50 }
      });
    }
  </script>
</body>
</html>
