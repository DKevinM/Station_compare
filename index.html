<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Station + Parameter Viewer</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <style>
    select { width: 300px; margin-bottom: 10px; }
    body { font-family: Arial, sans-serif; padding: 20px; }
  </style>
</head>
<body>
  <h2>Select Stations</h2>
  <select id="stationDropdown" multiple></select>

  <h2>Select Parameters</h2>
  <select id="parameterDropdown" multiple></select>

  <h3>Select Date Range</h3>
  <label>Start Date: <input type="date" id="startDate"></label>
  <label>End Date: <input type="date" id="endDate"></label>


  <div id="plot" style="width: 100%; height: 600px; margin-top: 20px;"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL= 'https://zcunoncbyitfsilrhymv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjdW5vbmNieWl0ZnNpbHJoeW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3Mjk3NDYsImV4cCI6MjA2NzMwNTc0Nn0._z_tqm_5UIBkWfMa7HAJrUOA-0t9vOaBVV48-74esWQ';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const unitsLookup = {
      "AQHI": " ", "Ozone": "ppb", "Total Oxides of Nitrogen": "ppb",
      "Hydrogen Sulphide": "ppb", "Total Reduced Sulphur": "ppb", "Sulphur Dioxide": "ppb",
      "Fine Particulate Matter": "µg/m³", "Total Hydrocarbons": "ppm", "Carbon Monoxide": "ppm",
      "Wind Direction": "degrees", "Relative Humidity": "%", "Outdoor Temperature": "°C",
      "Nitric Oxide": "ppb", "Wind Speed": "km/hr", "Non-methane Hydrocarbons": "ppm",
      "Nitrogen Dioxide": "ppb", "Methane": "ppm"
    };

    const shortLookup = {
      "AQHI": "AQHI", "Ozone": "O3", "Total Oxides of Nitrogen": "NOX",
      "Hydrogen Sulphide": "H2S", "Total Reduced Sulphur": "TRS", "Sulphur Dioxide": "SO2",
      "Fine Particulate Matter": "PM2.5", "Total Hydrocarbons": "THC", "Carbon Monoxide": "CO",
      "Wind Direction": "wd", "Relative Humidity": "RH", "Outdoor Temperature": "ET",
      "Nitric Oxide": "NO", "Wind Speed": "ws", "Non-methane Hydrocarbons": "NMHC",
      "Nitrogen Dioxide": "NO2", "Methane": "CH4"
    };

    let recentData = [];
    let dataByStation = {};

    // Compute default date range (last 7 days)
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 14);
      
    // Query Supabase with dynamic range
    const startDateStr = start.toISOString().split('T')[0] + "T00:00:00Z";
    const endDateStr = end.toISOString().split('T')[0] + "T23:59:59Z";
    
    const { data, error } = await supabase
      .from('aqhi_data')
      .select('*')
      .gte('ReadingDate', startDateStr)
      .lte('ReadingDate', endDateStr);
    

    if (error) {
      console.error("Error fetching data:", error);
    } else {
      data.forEach(e => {
        e.ParameterName = e.ParameterName || "AQHI";
        e.Units = unitsLookup[e.ParameterName] || "";
        e.Shortform = shortLookup[e.ParameterName] || "";

        let v = parseFloat(e.Value);
        if (isNaN(v)) return;
        e.Value = v;

        const rawUTC = new Date(e.ReadingDate);
        if (isNaN(rawUTC)) return;
        e.RawDate = rawUTC;

        e.ReadingDate = rawUTC.toLocaleString("en-CA", {
          timeZone: "America/Edmonton",
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit", second: "2-digit",
          hour12: false
        });

        if (!dataByStation[e.StationName]) dataByStation[e.StationName] = {};
        if (!dataByStation[e.StationName][e.ParameterName]) dataByStation[e.StationName][e.ParameterName] = [];

        dataByStation[e.StationName][e.ParameterName].push(e);
        recentData.push(e);
      });

      initDropdownsAndPlot();
    }

    function initDropdownsAndPlot() {
      document.getElementById("startDate").value = startDateStr;
      document.getElementById("endDate").value = endDateStr;
      
      const stations = Object.keys(dataByStation).sort();
      const parameters = [...new Set(recentData.map(e => e.ParameterName))].sort();

      const stationDropdown = document.getElementById("stationDropdown");
      const parameterDropdown = document.getElementById("parameterDropdown");

      stations.forEach(station => {
        const opt = document.createElement("option");
        opt.value = station;
        opt.textContent = station;
        stationDropdown.appendChild(opt);
      });

      parameters.forEach(param => {
        const opt = document.createElement("option");
        opt.value = param;
        opt.textContent = param;
        parameterDropdown.appendChild(opt);
      });

      const stationChoices = new Choices(stationDropdown, { removeItemButton: true });
      const paramChoices = new Choices(parameterDropdown, { removeItemButton: true });

      stationChoices.setChoiceByValue(["Edmonton East"]);
      paramChoices.setChoiceByValue(["Wind Direction"]);

      plotFiltered(["Edmonton East"], ["Wind Direction"]);

      stationDropdown.addEventListener("change", updatePlot);
      parameterDropdown.addEventListener("change", updatePlot);
      document.getElementById("startDate").addEventListener("change", updatePlot);
      document.getElementById("endDate").addEventListener("change", updatePlot);
    }

    function updatePlot() {
      const selectedStations = Array.from(document.getElementById("stationDropdown").selectedOptions).map(opt => opt.value);
      const selectedParams = Array.from(document.getElementById("parameterDropdown").selectedOptions).map(opt => opt.value);
      const startDate = new Date(document.getElementById("startDate").value);
      const endDate = new Date(document.getElementById("endDate").value);
      plotFiltered(selectedStations, selectedParams, startDate, endDate);
    }

    function plotFiltered(stationList, paramList, startDate, endDate) {
      const traces = [];

      stationList.forEach(station => {
        const stationData = dataByStation[station] || {};
        paramList.forEach(param => {
          const paramData = stationData[param] || [];

          const filtered = paramData.filter(e => e.RawDate >= startDate && e.RawDate <= endDate);

          if (filtered.length > 0) {
            traces.push({
              x: filtered.map(e => e.ReadingDate),
              y: filtered.map(e => e.Value),
              mode: 'lines+markers',
              name: `${shortLookup[param] || param} (${station})`,
              text: filtered.map(e => `${e.StationName}: ${e.Value} ${e.Units}`),
              hoverinfo: 'x+y+text'
            });
          }
        });
      });

      Plotly.newPlot("plot", traces, {
        title: "Parameter Time Series",
        xaxis: { title: "Time", tickformat: "%Y-%m-%d %H:%M" },
        yaxis: { title: "Value" },
        margin: { t: 50 },
        hovermode: "x unified"
      });
    }
  </script>
</body>
</html>
