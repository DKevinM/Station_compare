<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Station + Parameter Viewer</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
  <style>
    select { width: 300px; margin-bottom: 10px; }
    body { font-family: Arial, sans-serif; padding: 20px; }
  </style>
</head>
<body>
  <h2>Select Stations</h2>
  <select id="stationDropdown" multiple></select>

  <h2>Select Parameters</h2>
  <select id="parameterDropdown" multiple></select>
  
  <h3>Select Time Range</h3>
  <div id="timeSlider" style="margin: 30px 0;"></div>


  <div id="plot" style="width: 100%; height: 600px; margin-top: 20px;"></div>

  <script type="module">
    const SUPABASE_URL = 'https://zcunoncbyitfsilrhymv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjdW5vbmNieWl0ZnNpbHJoeW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3Mjk3NDYsImV4cCI6MjA2NzMwNTc0Nn0._z_tqm_5UIBkWfMa7HAJrUOA-0t9vOaBVV48-74esWQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const unitsLookup = {
      "AQHI": " ", "Ozone": "ppb", "Total Oxides of Nitrogen": "ppb",
      "Hydrogen Sulphide": "ppb", "Total Reduced Sulphur": "ppb", "Sulphur Dioxide": "ppb",
      "Fine Particulate Matter": "µg/m³", "Total Hydrocarbons": "ppm", "Carbon Monoxide": "ppm",
      "Wind Direction": "degrees", "Relative Humidity": "%", "Outdoor Temperature": "°C",
      "Nitric Oxide": "ppb", "Wind Speed": "km/hr", "Non-methane Hydrocarbons": "ppm",
      "Nitrogen Dioxide": "ppb", "Methane": "ppm"
    };

    const shortLookup = {
      "AQHI": "AQHI", "Ozone": "O3", "Total Oxides of Nitrogen": "NOX",
      "Hydrogen Sulphide": "H2S", "Total Reduced Sulphur": "TRS", "Sulphur Dioxide": "SO2",
      "Fine Particulate Matter": "PM2.5", "Total Hydrocarbons": "THC", "Carbon Monoxide": "CO",
      "Wind Direction": "wd", "Relative Humidity": "RH", "Outdoor Temperature": "ET",
      "Nitric Oxide": "NO", "Wind Speed": "ws", "Non-methane Hydrocarbons": "NMHC",
      "Nitrogen Dioxide": "NO2", "Methane": "CH4"
    };

    // Set default range (last 7 days)
    const now = new Date();
    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    const slider = document.getElementById("timeSlider");
    
    noUiSlider.create(slider, {
      start: [sevenDaysAgo.getTime(), now.getTime()],
      connect: true,
      range: {
        min: sevenDaysAgo.getTime(),
        max: now.getTime()
      },
      tooltips: [true, true],
      format: {
        to: value => new Date(+value).toLocaleString("en-CA", {
          timeZone: "America/Edmonton",
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit"
        }),
        from: value => Date.parse(value)
      }
    });
    
    // Attach slider change to updatePlot
    slider.noUiSlider.on("change", async () => {
      await fetchAndPlot(); // Replace with your main update function
    });


    const { data: stationData, error: stationErr } = await supabase
      .from("aqhi_data")
      .select("StationName")
      .neq("StationName", "")
      .limit(10000);
    const stations = [...new Set(stationData.map(d => d.StationName))].sort();
    const { data: paramData, error: paramErr } = await supabase
      .from("aqhi_data")
      .select("ParameterName")
      .neq("ParameterName", "")
      .limit(10000);
    const parameters = [...new Set(paramData.map(d => d.ParameterName))].sort();

    const stationDropdown = document.getElementById("stationDropdown");
    const parameterDropdown = document.getElementById("parameterDropdown");

    stations.forEach(station => {
      const opt = document.createElement("option");
      opt.value = station;
      opt.textContent = station;
      stationDropdown.appendChild(opt);
    });

    parameters.forEach(param => {
      const opt = document.createElement("option");
      opt.value = param;
      opt.textContent = param;
      parameterDropdown.appendChild(opt);
    });

    const stationChoices = new Choices(stationDropdown, { removeItemButton: true });
    const paramChoices = new Choices(parameterDropdown, { removeItemButton: true });

    document.getElementById("startDate").valueAsDate = new Date(new Date().setDate(new Date().getDate() - 2));
    document.getElementById("endDate").valueAsDate = new Date();

    stationChoices.setChoiceByValue(["Edmonton East", "St. Albert", "Woodcroft", "Edmonton Lendrum", "Edmonton McCauley"]);
    paramChoices.setChoiceByValue(["Wind Direction"]);


    async function fetchAndPlot() {
      const selectedStations = Array.from(stationDropdown.selectedOptions).map(opt => opt.value);
      const selectedParams = Array.from(parameterDropdown.selectedOptions).map(opt => opt.value);
      const [startRaw, endRaw] = slider.noUiSlider.get(true); // true = return as numbers
      const start = new Date(+startRaw).toISOString();
      const end = new Date(+endRaw).toISOString();

      const traces = [];

      for (const station of selectedStations) {
        for (const param of selectedParams) {
          const { data, error } = await supabase
            .from('aqhi_data')
            .select('*')
            .eq('StationName', station)
            .eq('ParameterName', param)
            .gte('ReadingDate', start)
            .lte('ReadingDate', end)
            .order('ReadingDate', { ascending: true });

          if (error || !data || data.length === 0) {
            console.warn(`No data for ${station} / ${param}`);
            continue;
          }

          traces.push({
            x: data.map(d => new Date(d.ReadingDate)),
            y: data.map(d => parseFloat(d.Value)),
            mode: 'lines+markers',
            name: `${shortLookup[param] || param} (${station})`,
            text: data.map(d => {
              const local = new Date(d.ReadingDate).toLocaleString("en-CA", {
                timeZone: "America/Edmonton",
                year: "numeric", month: "2-digit", day: "2-digit",
                hour: "2-digit", minute: "2-digit", second: "2-digit",
                hour12: false
              });
              return `${station}: ${d.Value} ${unitsLookup[param] || ""} @ ${local}`;
            }),
            hoverinfo: 'x+y+text'
          });
        }
      }

      Plotly.newPlot("plot", traces, {
        title: "Parameter Time Series",
        xaxis: {
          title: "Time",
          type: "date",
          tickformat: "%Y-%m-%d %H:%M",
          tickformatstops: [
            {
              dtickrange: [null, "M1"],
              value: "%Y-%m-%d %H:%M"
            }
          ]
        },
        yaxis: { title: "Value" },
        margin: { t: 50 },
        hovermode: "x unified"
      });
    }

    stationDropdown.addEventListener("change", fetchAndPlot);
    parameterDropdown.addEventListener("change", fetchAndPlot);
    document.getElementById("startDate").addEventListener("change", fetchAndPlot);
    document.getElementById("endDate").addEventListener("change", fetchAndPlot);

    fetchAndPlot(); // Initial plot
  </script>
</body>
</html>
